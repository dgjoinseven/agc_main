<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Angel City</title> 
    <meta name="viewport" content="width=device-width,user-scalable=no, initial-scale=1">
    <link rel='icon' href='./img/logo_16.ico' type='image/x-ico' />
    <script type="text/javascript" src="../vendor/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../vendor/jquery/jquery.cookie.js"></script>
    <script type="text/javascript" src="../vendor/clipboard.min.js"></script>
</head>


<body class="body_css">
    <!--主页面容器-->
    <div class="main_page" id="id_main_page" style="display:none;">
        <img src="./img/bg_top.jpg">
        <div id="id_top" class="abs" style="left:50px; top:50px; width:650px;">
            <div id="id_btn_back" class="abs" style="left:0px; top:0px;"><img src="./img/btn_back.png"></div>
            <div id="id_btn_logo_dyn" class="abs" style="right:0px; top:0px;"><img src="./img/logo_dyn.png"></div>
            <div id="id_btn_logo_market" class="abs" style="right:90px; top:0px;"><img src="./img/logo_market.png"></div>
            <div id="id_btn_logo_jc" class="abs" style="right:180px; top:0px;"><img src="./img/logo_jc.png"></div>
            <div id="id_btn_logo_fh" class="abs" style="right:270px; top:0px;"><img src="./img/logo_fh.png"></div>
            <!-- <label id="txt_exchange" class="abs txt_32 txt_w1 txt_r cl_white" style="right:80px; top:0px; width:300px;">0</label> -->
            <div class="abs txt_32 txt_w1" style="left:220px; top:70px;">
                <label id="txt_title_account" style="color:#FFF;"></label>
                <label id="txt_title_status" style="margin-left:30px;"></label>
            </div>
            <label class="abs txt_38 txt_w2" style="color:#FFF; left:220px; top:120px;">
                <label style="margin-left:0px;" data-lang="main.轮数"></label>
                <label id="txt_title_rounds" style="margin-left:10px;"></label>
            </label>
            <div id="id_myHead" class="abs" style="left:0px; top:60px;">
                <img class="abs" style="left:0px; top:0px;" src="./img/mask_r_205.png">
                <img id="id_head" class="abs" style="-webkit-mask:url(./img/mask_r_200.png); left:2px; top:2px;" src="">
            </div>
        </div>
        
        <div class="abs" style="left:310px; top:250px;">
            <div id="id_btn_pay_processing" class="abs btn txt_22 txt_c btn_payment_1" style="left:0px; top:0px;" data-lang="main.处理中"></div>
            <div id="id_btn_pay_finished" class="abs btn txt_22 txt_c btn_payment_0" style="left:220px; top:0px;" data-lang="main.已完成"></div>\
        </div>

        <!-- 表格内容 -->
        <div id="id_table_a_content" class="abs" style="left:50px; top:350px; width:650px; height:1100px;"></div>
    </div>

    <!-- 支付信息详情 -->
    <div id="id_table_detail" class="abs" style="position:fixed; z-index:2000; width:100%; height:100%; display:none;">
        <div class="bg_mask" ></div>
        <div class="abs bg_bottom" style="height:1150px;">
            <label class="abs txt_c txt_w2 txt_36 bg_base" style="width:750px; height:90px; line-height:90px;" data-lang="main.支付详情"></label>
            <div id="id_btn_details_close" class="abs" style="right:30px; top:30px; cursor:pointer;"><img src="./img/btn_close_1.png"></div>
            <!-- 人民币支付 -->
            <div id="id_details_rmb" class="abs" style="left:50px; top:120px; display:none;">
                <div id="id_img_small_container" class="abs" style="left:210px; top:0px; width:220px; height:220px; border:1px solid #666;">
                    <img id="id_img_small" class="abs" style="left:10px; top:10px; width:200px; height:200px; display:none;" >
                    <img id="id_img_default" class="abs" style="left:10px; top:10px; width:200px; height:200px;" src="./img/upload_img.png">
                </div>
                <div id="id_btn_upload" class="abs btn_b btn_b_orange" style="left:230px; top:240px; width:180px; height:50px;" data-lang="main.上传图片"></div>
                <input id="id_mine_rn_img_click" type="file" class="abs bg_red" style="left:230px; top:240px; width:180px; height:50px; cursor:pointer; opacity:0;">
                <div class="abs txt_28" style="left:0px; top:350px;">
                    <label class="abs txt_r" style="width:200px; top:0px;" data-lang="main.银行名称"></label><label id="id_txt_bank_name" class="abs details_txt" style="top:0px;"></label>
                    <label class="abs txt_r" style="width:200px; top:60px;" data-lang="main.银行账号"></label><label id="id_txt_bank_account" class="abs details_txt" style="top:60px;"></label>
                    <label class="abs txt_r" style="width:200px; top:120px;" data-lang="main.支行名称"></label><label id="id_txt_bank_branch" class="abs details_txt" style="top:120px;"></label>
                    <label class="abs txt_r" style="width:200px; top:180px;" data-lang="main.收款人姓名"></label><label id="id_txt_bank_payee" class="abs details_txt" style="top:180px;"></label>
                    <label class="abs txt_r" style="width:200px; top:240px;" data-lang="main.收款人电话"></label><label id="id_txt_bank_tel" class="abs details_txt" style="top:240px;"></label>
                    <label class="abs txt_r" style="width:200px; top:320px;" data-lang="main.支付宝账号"></label><label id="id_txt_alipay" class="abs details_txt" style="top:320px;"></label>
                </div>
            </div>

            <!-- AGC支付 -->
            <div id="id_details_agc" class="abs txt_28" style="left:0px; top:120px; display:none;">
                <label class="abs txt_r" style="width:200px; top:150px;" data-lang="main.交易ID"></label>
                <textarea id="id_input_agc_tran" class="abs txt_28" style="left:220px; top:150px; width:400px; height:80px; line-height:40px; display:none;" data-placeholder="ph.请输入内容"></textarea>
                <div id="id_btn_agc_tran" class="abs btn_b btn_b_orange" style="left:480px; top:260px; width:150px; height:50px; line-height:50px; display:none;" data-lang="main.确认"></div>
                <label id="id_txt_agc_tran" class="abs details_txt cl_blue" style="top:150px; display:none;"></label>

                <label class="abs txt_r" style="width:200px; top:350px;" data-lang="main.AGC地址"></label><label id="id_txt_agc_addr" class="abs details_txt textCanSelect" style="top:350px;"></label>
                <div id="id_txt_agc_copy" class="abs btn_b btn_b_orange" style="left:480px; top:420px; width:150px; height:50px; line-height:50px;" data-clipboard-action="copy" data-clipboard-target="#id_txt_agc_addr" data-lang="main.复制"></div>
            </div>

            <!-- 拒绝 -->
            <div id="id_details_refuse" class="abs txt_28" style="left:0px; top:600px; display:inline;">
                <div id="id_refuse_btn" class="abs btn_b btn_b_red" style="left:530px; top:260px; width:180px; height:80px; line-height:80px; display:none;" data-lang="main.拒绝"></div>
                <textarea id="id_refuse_textarea" class="abs" style="font-size:28px; left:100px; top:260px; width:400px; height:80px; line-height:40px;" onKeyUp="if(this.value.length > 30) this.value=this.value.substr(0,30)" data-placeholder="ph.最多输入30个字"></textarea>
                <label id="id_refuse_title" class="abs txt_28" style="color:#f00; left:100px; top:260px; width:180px;" data-lang="main.拒绝"></label>
                <label id="id_refuse_txt" class="abs txt_24" style="color:#840000; left:100px; top:290px; width:600px; height:60px; line-height:30px; "></label>
            </div>

            <!-- 申诉 -->
            <div id="id_details_appeal" class="abs txt_28" style="left:0px; top:700px; display:inline;">
                <div id="id_appeal_btn" class="abs btn_b btn_b_green" style="left:530px; top:260px; width:180px; height:80px; line-height:80px; display:none;" data-lang="main.申诉"></div>
                <textarea id="id_appeal_textarea" class="abs" style="font-size:28px; left:100px; top:260px; width:400px; height:80px; line-height:40px;" onKeyUp="if(this.value.length > 30) this.value=this.value.substr(0,30)" data-placeholder="ph.最多输入30个字"></textarea>
                <label id="id_appeal_title" class="abs txt_28" style="color:#169e00; left:100px; top:260px; width:180px;" data-lang="main.申诉"></label>
                <label id="id_appeal_txt" class="abs txt_24" style="color:#3a7a2f; left:100px; top:290px; width:600px; height:60px; line-height:30px; "></label>
            </div>
        </div>
    </div>

    <!-- 图片 -->
    <div id="id_big_img" class="abs" style="z-index:2000; width:100%; height:100%; display:none;">
        <div class="bg_mask" ></div>
            <div id="id_btn_img_close" class="abs" style="right:40px; top:40px; cursor:pointer;"><img src="./img/btn_close_2.png"></div>
            <img id="id_img_details" class="abs" style="left:0px; top:120px; width:750px;">
        </div>
    </div>

    <div id="id_end" class="abs" style="top:1000px; opacity:0;">.</div>

    <div id="id_header"></div>
    <div id="id_footer"></div>
    <div id="id_confirmwin"></div>
    <div id="id_popupwin"></div>
    <div id="id_tips"></div>

<script>
/////////////////// 初始化基础配置相关 ///////////////////
var zHead = document.getElementsByTagName('head')[0];
var zScript = document.createElement('script');
zScript.type = 'text/javascript';
zScript.src = '../vendor/common.js?ver='+$.cookie('commonJsVer');
zScript.onload = zScript.onreadystatechange = function() {
    if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete" ){
        common.init(['c_m_popUpWin', 'c_m_footer', 'c_m_pwd2', 'c_m_waiting']);
    }
}
zHead.appendChild(zScript);
var id_interval = 0;
window.onload = function ready(){id_interval=setInterval(function(){if(common!=undefined && common.JS_IS_LOADED==true){clearInterval(id_interval); init();}}, 100);};
/////////////////// 初始化基础配置相关 ///////////////////
window.onresize = windowResize;

var endHeight = 2200;
var userInfo = {};
var myInfoList = [];
var isFirst = true;
var exchangeList = [];
var isFinish = 0;
var selectedInfo;


//初始化
function init() {
    c_m_footer.init("id_footer", 2);

    $('#id_myHead').click({myType:"id_myHead"}, btnClickHandler);
    $('#id_btn_back').click({myType:"id_btn_back"}, btnClickHandler);
    $('#id_btn_logo_dyn').click({myType:"id_btn_logo_dyn"}, btnClickHandler);
    $('#id_btn_logo_market').click({myType:"id_btn_logo_market"}, btnClickHandler);
    $('#id_btn_logo_jc').click({myType:"id_btn_logo_jc"}, btnClickHandler);
    $('#id_btn_logo_fh').click({myType:"id_btn_logo_fh"}, btnClickHandler);
    $('#id_btn_pay_processing').click({myType:"id_btn_pay_processing"}, btnClickHandler);
    $('#id_btn_pay_finished').click({myType:"id_btn_pay_finished"}, btnClickHandler);
    $('#id_btn_details_close').click({myType:"id_btn_details_close"}, btnClickHandler);
    $('#id_btn_img_close').click({myType:"id_btn_img_close"}, btnClickHandler);
    $('#id_img_small_container').click({myType:"id_img_small_container"}, btnClickHandler);
    $('#id_refuse_btn').click({myType:"id_refuse_btn"}, btnClickHandler);
    $('#id_appeal_btn').click({myType:"id_appeal_btn"}, btnClickHandler);
    $('#id_txt_agc_tran').click({myType:"id_txt_agc_tran"}, btnClickHandler);
    $('#id_btn_agc_tran').click({myType:"id_btn_agc_tran"}, btnClickHandler);
    $('#id_mine_rn_img_click').on("change", api_uploadImg);

    
    windowResize();

    api_userInfo();

    common.lang();
    $('#id_main_page').show();

    setInterval(timeRum, 1000);

    new Clipboard('#id_txt_agc_copy', {text: function(trigger) {
        c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips.1", "tips.b_ok");
    }});

    // c_m_pwd2.init("id_confirmwin", 1, 2, 2);
}

//按钮点击事件
function btnClickHandler(p_obj_event){
    switch(p_obj_event.data.myType){
        case "id_myHead":
            c_m_waiting.init("id_tips");
            common.gotoWebSite('mine.html');
            break;
        case "id_btn_back":
            common.onBackFun();
            break;
        case "id_btn_logo_dyn":
            c_m_waiting.init("id_tips");
            common.gotoWebSite('serGroupBonus.html');
            break;
        case "id_btn_logo_market":
            c_m_waiting.init("id_tips");
            common.gotoWebSite('market.html');
            break;
        case "id_btn_logo_jc":
            c_m_waiting.init("id_tips");
            common.gotoWebSite('setJc.html');
            break;
        case "id_btn_logo_fh":
            c_m_waiting.init("id_tips");
            common.gotoWebSite('showFh.html');
            break;
        case "id_btn_invite_friends":
            c_m_waiting.init("id_tips");
            common.gotoWebSite('invitation.html');
            break;
        case "id_btn_pay_processing":
            selectBtn(0);
            break;
        case "id_btn_pay_finished":
            selectBtn(1);
            break;
        case "id_btn_details_close":
            $('#id_table_detail').hide();
            break;
        case "id_btn_img_close":
            $('#id_big_img').hide();
            break;
        case "id_txt_agc_tran":
            var zUrl = "https://etherscan.io/tx/"+selectedInfo.agcTran;
            window.open(zUrl, '_blank');
            break;
        case "id_btn_agc_tran":
            api_orderSetInfo(selectedInfo.order_id, $('#id_input_agc_tran').val());
            break;
        case "id_img_small_container":
            var zImgUrlInfo = {};
            zImgUrlInfo.img_url = $('#id_img_small').attr("src");
            onImgClickHander(zImgUrlInfo);
            break;
        case "id_refuse_btn":
            orderEdit(selectedInfo.order_id, 3, $('#id_refuse_textarea').val());
            break;
        case "id_appeal_btn":
            orderEdit(selectedInfo.order_id, 4, $('#id_appeal_textarea').val());
            break;
    }
}

//窗口尺寸重置
function windowResize()
{
    var zScale = common.initScale(1);
    zScale = (zScale<1) ? 1 : zScale;
    
    var zWinWidth = parseInt(window.screen.availWidth);
    var zWineHeight = parseInt(window.screen.availHeight);
    var zMyWidth = document.body.clientWidth;
    var zObjWidth = parseInt($('#id_main_page').css("width"))*zScale;

    var zMiddleWidth = (zMyWidth-zObjWidth)/2/zScale;
    $('#id_main_page').css({"left":zMiddleWidth+"px"});

    // c_m_header.windowResize(zMiddleWidth);
    c_m_footer.windowResize(zMiddleWidth);
    c_m_footer.updateTop(endHeight);
    c_m_popUpWin.setSizePos(zScale);
}

//选择进行中/已完成
function selectBtn(pIndex){
    isFinish = pIndex;
    $('#id_btn_pay_processing').removeClass("btn_payment_1");
    $('#id_btn_pay_finished').removeClass("btn_payment_1");
    $('#id_btn_pay_processing').removeClass("btn_payment_0");
    $('#id_btn_pay_finished').removeClass("btn_payment_0");
    if(isFinish==0){
        $('#id_btn_pay_processing').addClass("btn_payment_1");
        $('#id_btn_pay_finished').addClass("btn_payment_0");
        api_orderList(userInfo.id, 0);
    }else{
        $('#id_btn_pay_processing').addClass("btn_payment_0");
        $('#id_btn_pay_finished').addClass("btn_payment_1");
        api_orderList(userInfo.id, 1);
    }
}

function updateMySelf(){
    var zImgUrl =  "./img/head/head_" + userInfo.img_id + ".jpg";
    $('#id_head').attr("src", zImgUrl);

    // if(exchangeList && exchangeList[0]){
    //     var zCurExchangeRate = exchangeList[0].rate;
    //     common.setCookie("exchangeRate", zCurExchangeRate);
        // var zExchangeShowStr = "$1 = " + zCurExchangeRate + common.COIN_NAME;
        // $('#txt_exchange').text(zExchangeShowStr);
    // }

    $('#txt_title_status').attr("data-lang", "main.status_"+userInfo.status);
    var zColor = "#FFF";
    switch(userInfo.status){
        case 0:
            zColor = "#ccc";
            break;
        case 1:
            zColor = "#aaeaff";
            break;
        case 2:
            zColor = "#ffde6b";
            break;
    }
    $('#txt_title_status').css("color", zColor);
    $('#txt_title_rounds').text(userInfo.rounds);
    $('#txt_title_account').html(userInfo.name);
}

//更新列表
function updateTable(){
    var zHmlInfo = "";
    var zTop = 0;
    // var zCurExchangeRate = common.getCookie("exchangeRate");
    for(var i=0; i<myInfoList.length; i++){
        zTop = i*210;
        var zInfo = myInfoList[i];
        var zOrderType = parseInt(zInfo.order_type);//订单类型（1.天使轮打款  2.公排boss1打款  3.公排boss2打款  4.公排销毁打款【lock】  5.公排公共账号打款【sys】  6.大转盘收款【sys】  7.排单收款  8.动态奖收款【sys】 9.出局分红【sys】）
        var zOrderStr = 'data-lang="main.order_type_'+zOrderType+'"';
        var zRounds = zInfo.rounds;
        var zStatus = parseInt(zInfo.status);
        var zFromId = parseInt(zInfo.from_id);
        var zFromAddr = zInfo.from_addr;
        var zFromBank = zInfo.from_bank;
        var zFromAlipay = zInfo.from_alipay;
        var zFromType = zInfo.from_addr_type;
        var zToId = parseInt(zInfo.to_id);
        var zToAddr = zInfo.to_addr;
        var zToBank = zInfo.to_bank;
        var zToAlipay = zInfo.to_alipay;
        var zToType = zInfo.to_addr_type;
        var zIsNotShowAGC = " display:none;";
        var zIsNotShowRMB = " display:none;";
        var zMoney = "";
        if(zInfo.is_rmb==1){
            zMoney = "￥"+ zInfo.money;
            zIsNotShowRMB = "";
        }else{
            zMoney = zInfo.money_agc+"AGC";
            zIsNotShowAGC = "";
        }
        var zUpdateTime = zInfo.update_time;
        var zBtnClass=""; //状态（0未打款   1已打款   2已确认）
        var zBtnName = "";
        var zAddrTxt = "";
        var zPayState = "";
        var zPayStateColor = "";
        var zAddrTypeList = ["", "ERC20", "OMNI"];
        var zAddrType = "";
        var zMoneyGetType = 0; // 1打钱  2收钱
        var zAcount = "";
        var zClickTxt = "";
        var zImgName = "";
        var zTimeDisplay="";
        var zTel = "";
        var zClickDetailInfo = {};
        zClickDetailInfo.rounds = zInfo.rounds;
        zClickDetailInfo.from_id = zFromId;
        zClickDetailInfo.to_id = zToId;
        zClickDetailInfo.img_url = zInfo.img_url;
        zClickDetailInfo.img_sum = zInfo.img_sum;
        zClickDetailInfo.order_id = zInfo.id;
        zClickDetailInfo.is_rmb = zInfo.is_rmb;
        zClickDetailInfo.status = zStatus;
        zClickDetailInfo.reason_refuse = zInfo.reason_refuse;
        zClickDetailInfo.reason_appeal = zInfo.reason_appeal;
        zClickDetailInfo.tel = zInfo.to_tel;
        var zClickDetailTxt = "";
        var zClickImgInfo = {};
        zClickImgInfo.img_url = zInfo.img_url;
        var zClickImgTxt = "";
        if(parseInt(zFromId)==parseInt(userInfo.id)){//付钱
            zMoneyGetType = 1;
            
            if(zOrderType==4){ //打给锁币账号
                zAddrTxt = zInfo.lock_addr;
            }else if(zOrderType==5){ //打给公共账号
                zAddrTxt = zInfo.sys_addr;
            }else{
                zAddrTxt =  zToAddr;
            }

            zAcount = zInfo.to_name;
            zClickDetailInfo.bank = zToBank;
            zClickDetailInfo.alipay = zToAlipay;
            zClickDetailInfo.moneyGetType = zMoneyGetType;
            zClickDetailInfo.agcAddr = zAddrTxt;
            zClickDetailInfo.agcTran = zInfo.tran_id;
            zClickDetailTxt = " onClick='onDetailClickHander("+JSON.stringify(zClickDetailInfo)+")' ";
            zClickImgTxt = " onClick='onImgClickHander("+JSON.stringify(zClickImgInfo)+")' ";
            zBtnClass="btn_payment_"+zStatus+"1";
            zBtnName = "main.btn_payment_"+zStatus+"1";
            zTel = zInfo.to_tel;
            zPayState = "main.付款者";
            zPayStateColor = "#3da200";
            if(parseInt(zStatus)==0){
                zClickTxt = " onClick='onListClickHander("+JSON.stringify(zClickDetailInfo)+")' ";
            }
            zImgName = "./img/head/head_"+zInfo.to_img_id+".jpg";
            if(zInfo.to_id==0){
                zAcount = "";
                zImgName = "./img/head/sys_get.jpg";
            }else if(zInfo.to_id==-1){
                zAcount = "";
                zImgName = "./img/head/sys_lock.jpg";
            }else if(zInfo.to_id==-99){
                zAcount = "";
                zImgName = "./img/head/sys_what.jpg";
            }
        }else{//收钱
            zMoneyGetType = 2;
            
            if(zOrderType==6){ //大转盘打过来
                zAddrTxt = zInfo.sys_addr;
            }else if(zOrderType==8){ //动态奖打过来
                zAddrTxt = zInfo.sys_addr;
            }else{
                zAddrTxt = zFromAddr;
            }

            zClickDetailInfo.bank = zFromBank;
            zClickDetailInfo.alipay = zFromAlipay;
            zClickDetailInfo.moneyGetType = zMoneyGetType;
            zClickDetailInfo.agcAddr = zAddrTxt;
            zClickDetailInfo.agcTran = zInfo.tran_id;
            zClickDetailTxt = " onClick='onDetailClickHander("+JSON.stringify(zClickDetailInfo)+")' ";
            zClickImgTxt = " onClick='onImgClickHander("+JSON.stringify(zClickImgInfo)+")' ";
            zAcount = zInfo.from_name;
            zTel = zInfo.from_tel;
            //如果时6，8两种公共平台给用户打款的情况，status为1即公共平台已打款情况，自动判断为status=2已完成
            if((zOrderType==6 || zOrderType==8) && zStatus==1){
                zStatus = 2;
            }
            zBtnClass="btn_payment_"+zStatus+"2";
            zBtnName = "main.btn_payment_"+zStatus+"2";
            zPayState = "main.收款者";
            zPayStateColor = "#FC7E2A";
            if(parseInt(zStatus)==1){
                zClickTxt = " onClick='onListClickHander("+JSON.stringify(zClickDetailInfo)+")' ";
            }
            zImgName = "./img/head/head_"+zInfo.from_img_id+".jpg";
            if(zInfo.from_id==0){
                zAcount = "";
                zImgName = "./img/head/sys_get.jpg";
            }else if(zInfo.from_id==-1){
                zAcount = "";
                zImgName = "./img/head/sys_lock.jpg";
            }else if(zInfo.from_id==-99){
                zAcount = "";
                zImgName = "./img/head/sys_what.jpg";
            }
        }

        //已完成，拒绝，申诉，申诉结束的单子不显示时间
        if(zStatus>=2){
            zTimeDisplay = "diplay:none;"
        }

        var zStr = '\
            <div class="abs bg_white" style="top:'+zTop+'px; width:650px; height:210px; background-color:rgba(0,0,0,0); border:0px solid #eee; border-bottom:2px solid #eee;">\
                <div class="abs" style="transform:scale(0.6,0.6); top:30px;"><img class="abs" style="-webkit-mask:url(./img/mask_r_200.png);" src="'+zImgName+'"></div>\
                <div class="abs txt_28 cl_grey" style="left:0px; top:170px;">\
                    <label>No.</label>\
                    <label>'+zInfo.id+'</label>\
                </div>\
                <div class="abs" style="left:140px; top:30px;">\
                    <label class="txt_36" style="color:'+zPayStateColor+';" data-lang="'+zPayState+'"></label>\
                    <label class="txt_36 txt_r txt_w1" style="color:'+zPayStateColor+'; margin-left:10px;">'+zMoney+'</label>\
                </div>\
                <div class="abs txt_28" style="left:140px; top:80px;">\
                    <label class="cl_black" style="margin-left:0px;">'+zAcount+'</label>\
                    <label class="cl_grey" style="margin-left:20px;" data-lang="main.轮数"></label>\
                    <label class="cl_grey" style="margin-left:0px;">'+zInfo.rounds+'</label>\
                </div>\
                <div class="abs txt_28" style="left:140px; top:120px;">\
                    <label class="cl_grey" style="margin-left:0px;" data-lang="main.联系电话"></label>\
                    <label class="cl_grey" style="margin-left:10px;">'+zTel+'</label>\
                </div>\
                <div class="abs" style="left:230px; top:160px;">\
                    <div id="id_btn_detail_'+zInfo.id+'" class="abs txt_c txt_24" style="background-color:#000; color:#FFF; border-radius:10px; width:160px; height:40px; line-height:40px;" '+zClickDetailTxt+' data-lang="main.支付详情"></div>\
                </div>\
                <div class="abs txt_28 txt_c '+zBtnClass+'" style="right:-10px; top:40px;" data-lang="'+zBtnName+'" '+zClickTxt+'></div>\
                <label id="id_obj_time_'+zInfo.id+'" class="abs txt_26 txt_r txt_w1 cl_grey4" style="right:20px; top:160px; width:200px; '+zTimeDisplay+'" data-pay-type="'+zMoneyGetType+'"></label>\
            </div>\
            ';
        zHmlInfo += zStr;
    }
    $('#id_table_a_content').html(zHmlInfo);

    endHeight = (myInfoList.length+1)*210+230;
    $('#id_end').css("top", endHeight+"px");

    common.lang();
}

//按钮被点击
function onListClickHander(pInfo){
    var zInfo = pInfo;
    selectedInfo = zInfo;
    orderEdit(zInfo.order_id, zInfo.moneyGetType);
}

//详情按钮点击
function onDetailClickHander(pInfo){
    var zInfo = pInfo;
    selectedInfo = zInfo;

    //显示人民币还是AGC
    if(parseInt(zInfo.is_rmb)==1){
        var zBankInfo = {};
        if(zInfo.bank){
            zBankInfo = JSON.parse(zInfo.bank);
        }else{
            zBankInfo.bank = "";
            zBankInfo.account = "";
            zBankInfo.branch = "";
            zBankInfo.name = "";
            zInfo.tel = "";
            zInfo.alipay = "";
        }
        $('#id_txt_bank_name').text(zBankInfo.bank);
        $('#id_txt_bank_account').text(zBankInfo.account);
        $('#id_txt_bank_branch').text(zBankInfo.branch);
        $('#id_txt_bank_payee').text(zBankInfo.name);
        $('#id_txt_bank_tel').text(zInfo.tel);
        $('#id_txt_alipay').text(zInfo.alipay);

        $('#id_details_rmb').show();
        $('#id_details_agc').hide();
    }else{
        $('#id_txt_agc_addr').text(zInfo.agcAddr);
        $('#id_txt_agc_tran').text(zInfo.agcTran);

        if(!zInfo.agcTran){
            $('#id_input_agc_tran').show();
            $('#id_btn_agc_tran').show();
            $('#id_txt_agc_tran').hide();
        }else{
            $('#id_input_agc_tran').hide();
            $('#id_btn_agc_tran').hide();
            $('#id_txt_agc_tran').show();
        }
        
        $('#id_details_rmb').hide();
        $('#id_details_agc').show();
    }

    // console.log(zInfo.moneyGetType, zInfo.status, zInfo.reason_refuse, zInfo.reason_appeal);

    //拒绝/申诉
    $('#id_refuse_txt').text(zInfo.reason_refuse);
    $('#id_appeal_txt').text(zInfo.reason_appeal);

    //付钱，收钱逻辑
    if(parseInt(zInfo.moneyGetType)==1){ //付钱
        var zConf = common.getCookie("conf");
        if(zConf && parseInt(zInfo.img_sum)>=zConf["upload_img_max"]){
            $('#id_btn_upload').hide();
            $('#id_mine_rn_img_click').hide();
        }else{
            $('#id_btn_upload').show();
            $('#id_mine_rn_img_click').show();
        }

        //拒绝显示逻辑
        if(parseInt(zInfo.status)==3 || parseInt(zInfo.status)==4){
            $('#id_details_refuse').show();
            $('#id_refuse_btn').hide();
            $('#id_refuse_textarea').hide();
            $('#id_refuse_title').show();
            $('#id_refuse_txt').show();
        }else{
            $('#id_details_refuse').hide();
        }

        //申诉显示逻辑
        if(parseInt(zInfo.status)==3 || parseInt(zInfo.status)==4){
            $('#id_details_appeal').show();
            if(zInfo.reason_appeal){
                $('#id_appeal_btn').hide();
                $('#id_appeal_textarea').hide();
                $('#id_appeal_title').show();
                $('#id_appeal_txt').show();
            }else{
                $('#id_appeal_btn').show();
                $('#id_appeal_textarea').show();
                $('#id_appeal_title').hide();
                $('#id_appeal_txt').hide();
            }
        }else{
            $('#id_details_appeal').hide();
        }
    }else{ //收钱
        $('#id_btn_upload').hide();
        $('#id_mine_rn_img_click').hide();

        //拒绝显示逻辑
        if(parseInt(zInfo.status)==1 || parseInt(zInfo.status)==3 || parseInt(zInfo.status)==4){
            $('#id_details_refuse').show();
            //如果拒绝过，则显示拒绝信息；如果没有拒绝过，则显示拒绝按钮和输入框
            if(zInfo.reason_refuse){
                $('#id_refuse_btn').hide();
                $('#id_refuse_textarea').hide();
                $('#id_refuse_title').show();
                $('#id_refuse_txt').show();
            }else{
                $('#id_refuse_btn').show();
                $('#id_refuse_textarea').show();
                $('#id_refuse_title').hide();
                $('#id_refuse_txt').hide();
            }
        }else{
            $('#id_details_refuse').hide();
        }

        //申诉显示逻辑
        if(parseInt(zInfo.status)==4){
            $('#id_details_appeal').show();
            $('#id_appeal_btn').hide();
            $('#id_appeal_textarea').hide();
            $('#id_appeal_title').show();
            $('#id_appeal_txt').show();
        }else{
            $('#id_details_appeal').hide();
        }
    }

    //图片
    if(zInfo.img_url){
        $('#id_img_default').hide();
        $('#id_img_small').attr("src", zInfo.img_url);
        $('#id_img_small').show();
    }else{
        $('#id_img_default').show();
        $('#id_img_small').hide();
    }

    //总显示
    $('#id_table_detail').show();
}

//图片点击
function onImgClickHander(pInfo){
    var zInfo = pInfo;
    if(zInfo.img_url){
        $('#id_img_details').attr("src", zInfo.img_url);
        $('#id_big_img').show();
    }
}



function timeRum(){
    const zTime = parseInt(Date.now()/1000);
    if(myInfoList && myInfoList.length>0){
        var zConf = common.getCookie("conf");
        var zPayMaxTime = parseInt(zConf["pay_time"])*3600;//时间限制
        var zConfirmMaxTime = parseInt(zConf["confirm_time"])*3600;

        for(var i=0; i<myInfoList.length; i++){
            var zInfo = myInfoList[i];
            var zPayShowTime = zInfo.create_time + zPayMaxTime - zTime;
            var zConfirmShowTime = zInfo.pay_time + zConfirmMaxTime - zTime;
            if(zPayShowTime<0){
                zPayShowTime = 0;
            }
            if(zConfirmShowTime<0){
                zConfirmShowTime = 0;
            }

            //判断显示哪个时间 //status：0未付款  1已付款  2已收款
            var zPayType = parseInt($('#id_obj_time_'+zInfo.id).attr("data-pay-type"));//付款状态：1付款  2收款
            switch(parseInt(zInfo.status)){
                case 0:
                    $('#id_obj_time_'+zInfo.id).html(common.getTimeStrFromNum(zPayShowTime));
                    break;
                case 1:
                    $('#id_obj_time_'+zInfo.id).html(common.getTimeStrFromNum(zConfirmShowTime));
                    break;
            }
        }
    }
}


//控制订单（1支付 2确定 3拒绝 4申诉）
//@pOrderId  订单ID
//@pType     订单类型（1支付 2确定 3拒绝 4申诉）
//@pReason   原因（订单类型为3/4时使用）
function orderEdit(pOrderId, pType, pReason){
    if(!userInfo.pwd2){
        c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "main.请设置交易密码", "tips.b_ok", function(){common.gotoWebSite('setpwd2.html')});
        return;
    }

    //如果点击支付，则判断以下内容
    if(pType==1){
        if(selectedInfo.rounds==0){ //天使轮
            if(!selectedInfo.bank || !selectedInfo.alipay){
                c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "main.请设置银行信息或支付宝账号", "tips.b_ok", function(){onDetailClickHander(selectedInfo)});
                return;
            }
            if(!selectedInfo.img_url){
                c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "main.请上传打款图片", "tips.b_ok", function(){onDetailClickHander(selectedInfo)});
                return;
            }
        }else{ //公排
            if(!selectedInfo.agcTran){
                c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "main.请输入交易单号", "tips.b_ok", function(){onDetailClickHander(selectedInfo)});
                return;
            }
        }
    }

    c_m_pwd2.init("id_confirmwin", pOrderId, pType, pReason);
}

//////////////////////////////////// php相关 ////////////////////////////////////
//获取用户id
function api_userInfo(){
    $.ajax({
        url: common.getApiUrl("user_detail"),
        type: "get",
        beforeSend: function(Request) {
            Request.setRequestHeader("Authorization",common.getCookie('token'));
        },
        data:{},
        dataType: "json", //指定服务器返回的数据类型
        cache:false,
        success: function (evt) {
            console.log("api_userInfo success:");
            console.log(evt);
            switch(evt.code){
                case 1:
                    userInfo = evt.data.userInfo;
                    exchangeList = evt.data.exchangeList;
                    common.setCookie("userInfo", JSON.stringify(evt.data.userInfo));
                    updateMySelf();
                    selectBtn(0);
                    break;
                case 10001:
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips.1003", "tips.b_ok", function(){common.gotoWebSite('login.html')});
                    break;
                default:
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips."+evt.code, "tips.b_ok");
                    break;
            }
        },error: function(error){
            console.log("api_userInfo error:"+error.msg);
        }
    });
}

//获取订单
//@pId 订单人
function api_orderList(pId, pIndex){
    c_m_waiting.init("id_tips");
    $.ajax({
        url: common.getApiUrl("order_list"),
        type: "get",
        beforeSend: function(Request) {
            Request.setRequestHeader("Authorization",common.getCookie('token'));
        },
        data:{id:pId, isFinish:pIndex},
        dataType: "json", //指定服务器返回的数据类型
        cache:false,
        success: function (evt) {
            console.log("api_orderList success:");
            console.log(evt);
            switch(evt.code){
                case 1:
                    myInfoList = evt.data.list;
                    updateTable();
                    break;
                default:
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips."+evt.code, "tips.b_ok");
                    break;
            }
            c_m_waiting.close();
        },error: function(error){
            console.log("api_orderList error:"+error.msg);
            c_m_waiting.close();
        }
    });
}

//上传图片
function api_uploadImg(){
    c_m_waiting.init("id_tips");
    var formData = new FormData();
    formData.append("token", common.getCookie('token'));
    formData.append("nickname", userInfo.name);
    formData.append("orderid", selectedInfo.order_id);
    var file = $("#id_mine_rn_img_click")[0].files[0];

    if(file.size==undefined){
        return;
    }

    var fSize = ((file.size)/1024).toFixed(2);//获取图片大小转换成KB
    //限制文件上传的大小在1-500KB以内
    if(fSize < 1 || fSize > 500){
        c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips.1030", "tips.b_ok");
        return;
    }

    formData.append("image", file);
    $.ajax({
        url: common.getApiUrl("upload_img"),
        type: 'POST',
        data: formData,
        processData: false,// 告诉jQuery不要去处理发送的数据
        contentType: false,// 告诉jQuery不要去设置Content-Type请求头
        beforeSend: function(){
            uploading = true;
        },
        success : function(evt) {
            console.log("api_uploadImg success:");
            console.log(evt);
            switch(evt.code){
                case 1:
                    var zUrl = evt.data.url;
                    $('#id_img_default').hide();
                    $('#id_img_small').attr("src", zUrl);
                    $('#id_img_small').show();
                    break;
                case 1030:
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips."+evt.code, "tips.b_ok");
                    break;
                default:
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips."+evt.code, "tips.b_ok");
                    console.log("图片上传失败");
                    break;
            }
            c_m_waiting.close();
        },error: function(error){
            console.log("api_uploadImg error:"+error.msg);
            c_m_waiting.close();
        }
    });
}

//支付/确认
function api_orderSetInfo(pOrderId, pTranId){
    c_m_waiting.init("id_tips");
    $.ajax({
        url: common.getApiUrl("orderSetInfo"),
        type: "post",
        beforeSend: function(Request) {
            Request.setRequestHeader("Authorization",common.getCookie('token'));
        },
        data:{id:pOrderId, tran_id:pTranId},
        dataType: "json", //指定服务器返回的数据类型
        cache:false,
        success: function (evt) {
            console.log("api_orderList success:");
            console.log(evt);
            switch(evt.code){
                case 1:
                case 10:
                    $('#id_c_m_pwd2_container').hide();
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips.1", "tips.b_ok", function(){common.onRefreshFun()});
                    break;
                default:
                    c_m_popUpWin.init("id_popupwin", 1, "tips.t_tips", "tips."+evt.code, "tips.b_ok");
                    break;
            }
            c_m_waiting.close();
        },error: function(error){
            console.log("api_orderList error:"+error.msg);
            c_m_waiting.close();
        }
    });
}

</script>

</body>
</html>